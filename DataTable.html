
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>EconR - doing economics with R</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <link href="./bootstrap/css/bootstrap.css" rel="stylesheet">
    <link rel="stylesheet" href="styles/magula.css">
    <script src="highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }

      @media (max-width: 980px) {
        /* Enable use of floated navbar text */
        .navbar-text.pull-right {
          float: none;
          padding-left: 5px;
          padding-right: 5px;
        }
      }
    </style>
    <link href="./bootstrap/css/bootstrap-responsive.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="./bootstrap/js/html5shiv.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="./bootstrap/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="./bootstrap/ico/apple-touch-icon-114-precomposed.png">
      <link rel="apple-touch-icon-precomposed" sizes="72x72" href="./bootstrap/ico/apple-touch-icon-72-precomposed.png">
                    <link rel="apple-touch-icon-precomposed" href="./bootstrap/ico/apple-touch-icon-57-precomposed.png">
                                   <link rel="shortcut icon" href="./bootstrap/ico/favicon.png">
  </head>

  <body>

    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="brand" href="#">Econ Notes</a>
          <div class="nav-collapse collapse">
            <p class="navbar-text pull-right">
              source on  <a href="https://github.com/tlamadon/econr-notes" class="navbar-link">github</a>
            </p>
            <ul class="nav">
              <li class="active"><a href="#">Home</a></li>
              <li class="dropdown">
                      <a href="#" class="dropdown-toggle" data-toggle="dropdown">Chapters <b class="caret"></b></a>
                      <ul class="dropdown-menu">
                          <li><a href="DataTable.html">DataTable</a></li>
                          <li><a href="savingRcppGSL.html">Consumption Saving Model</a></li>
                          <li><a href="BlitzExample.html">Blitz Example</a></li>
                          <li><a href="FortranAndR.html">Fortran And R</a></li>
                      </ul>
                  </li>
              <li><a href="#contact">Contact</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row-fluid">
        <div class="span3">
          <div class="well sidebar-nav">
            <ul class="nav nav-list">
              <li class="nav-header">topic 1</li>
              <li><a href="#">Link</a></li>
              <li class="nav-header">topic 2</li>
              <li><a href="#">Link</a></li>
            </ul>
          </div><!--/.well -->
        </div><!--/span-->
        <div class="span9">
            <p>This section will described how to use the <code>data.table</code> package. This package is a much faster implementation of the <code>data.frame</code> object which it also extends.</p>
<p>This is rather superficial overview of <code>data.table</code> where we describe briefly how to construct a panel data set with lagged variables. For a thorough overview of the capabilities of data.table, please refer to the excellent documentation of the package, for example in the vignettes at <a href="http://cran.r-project.org/web/packages/data.table/index.html">http://cran.r-project.org/web/packages/data.table/index.html</a></p>
<h2 id="the-structure-of-data.table">The structure of data.table</h2>
<p>A data.table is a collection of vectors of identical length. Each vector forms a column, and so the data.frame can be thought of as a table with a number of row and a number of columns. Those structures are often called <code>rogue arrays</code> (an non rogue array has a same type in every column).</p>
<p>So we can easily create such an object:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">require</span>(data.table)</code></pre>
<pre><code>## Loading required package: data.table</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">v1 =<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">l =</span> <span class="dv">10</span>)
v2 =<span class="st"> </span><span class="kw">sample</span>(<span class="kw">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;c&quot;</span>), <span class="dv">10</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>)
dd =<span class="st"> </span><span class="kw">data.table</span>(<span class="dt">i =</span> v1, <span class="dt">l =</span> v2)
dd</code></pre>
<pre><code>##          i l
##  1: 0.0000 b
##  2: 0.1111 b
##  3: 0.2222 a
##  4: 0.3333 c
##  5: 0.4444 b
##  6: 0.5556 c
##  7: 0.6667 c
##  8: 0.7778 a
##  9: 0.8889 a
## 10: 1.0000 c</code></pre>
<p>Then columns can be accessed by names using the dollar sign as in a standard data.frame, or by their name, or by handling the table as a list (a data.table <strong>is</strong> a list)</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># use dollar sign</span>
dd$i</code></pre>
<pre><code>##  [1] 0.0000 0.1111 0.2222 0.3333 0.4444 0.5556 0.6667 0.7778 0.8889 1.0000</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># same as using the j-argument, the list index or the the list name?</span>
<span class="kw">all</span>(<span class="kw">all.equal</span>(dd$i,dd[,i]),
    <span class="kw">all.equal</span>(dd$i,dd[[<span class="dv">1</span>]]),
    <span class="kw">all.equal</span>(dd$i,dd[[<span class="st">&quot;i&quot;</span>]]))</code></pre>
<pre><code>## [1] TRUE</code></pre>
<h2 id="the-3-arguments-of-in-data.table">The 3 arguments of <code>[</code> in data.table</h2>
<p>the first argument allows to subset the data, the second allows to perform function on that subset, the third argument allows to apply the function by groups. TBD.</p>
<h2 id="using-keys">Using <code>keys</code></h2>
<p>Here we show how the keys optins can be used to compute lag variables in a <code>data.table</code>. This requires that you understood the way data.table works.</p>
<p>For this we are going to use a simulated dynamic panel. This panel will represent draws from an AR(1) process with a random effect</p>
<p><br /><span class="math"><em>l</em><em>a</em><em>t</em><em>e</em><em>x</em><em>y</em><sub><em>i</em><em>t</em></sub> = <em>ρ</em> * <em>y</em><sub><em>i</em><em>t</em> − 1</sub> + <em>f</em><sub><em>i</em></sub> + <em>u</em><sub><em>i</em><em>t</em></sub></span><br /></p>
<p>Let's first generate the data in a very crude and slow way.</p>
<pre class="sourceCode r"><code class="sourceCode r">p =<span class="st"> </span><span class="kw">list</span>(<span class="dt">n =</span> <span class="dv">20</span>, <span class="dt">t =</span> <span class="dv">10</span>, <span class="dt">rho =</span> <span class="fl">0.8</span>, <span class="dt">f_sd =</span> <span class="fl">0.2</span>, <span class="dt">y0_sd =</span> <span class="dv">1</span>, <span class="dt">u_sd =</span> <span class="dv">1</span>)

<span class="co"># create 1 entry per individual and draw a random length</span>
dd =<span class="st"> </span><span class="kw">data.table</span>(<span class="dt">i =</span> <span class="dv">1</span>:p$n, <span class="dt">l =</span> <span class="kw">rpois</span>(p$n, p$t), <span class="dt">y0 =</span> <span class="kw">rnorm</span>(p$n, <span class="dt">sd =</span> p$y0_sd), 
    <span class="dt">f =</span> <span class="kw">exp</span>(<span class="kw">rnorm</span>(p$n, <span class="dt">sd =</span> p$y0_sd)))

<span class="co"># for each individual we create the time series</span>
dd =<span class="st"> </span>dd[, {
    y =<span class="st"> </span><span class="kw">rep</span>(<span class="dv">0</span>, l)
    y[<span class="dv">1</span>] =<span class="st"> </span>y0
    u =<span class="st"> </span><span class="kw">rnorm</span>(l, <span class="dt">sd =</span> p$u_sd)
    for (t in <span class="dv">2</span>:l) {
        y[t] =<span class="st"> </span>p$rho *<span class="st"> </span>y[t -<span class="st"> </span><span class="dv">1</span>] +<span class="st"> </span>f
    }
    <span class="kw">list</span>(<span class="dt">y =</span> y, <span class="dt">t =</span> <span class="dv">1</span>:l)
}, i]</code></pre>
<p>we plot for a few indidividuals:</p>
<div class="figure">
<img src="figure/unnamed-chunk-4.png" alt="plot of chunk unnamed-chunk-4" /><p class="caption">plot of chunk unnamed-chunk-4</p>
</div>
<h3 id="computing-panel-first-differences-using-data.table">computing panel first differences using data.table</h3>
<p>Now that we have our data set we can create the first difference to remove the fixed effect. To do so we are going to use the <code>keys</code> of data.table.</p>
<p>We first define the keys for the table. The keys should uniquely identify a row in the data. In our case (i,t) is enough.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">setkey</span>(dd, i, t)</code></pre>
<p>Next we can use the <code>J</code> function from the package to create the lag <code>y</code></p>
<pre class="sourceCode r"><code class="sourceCode r">dd$y.l1 =<span class="st"> </span>dd[<span class="kw">J</span>(i, t -<span class="st"> </span><span class="dv">1</span>), y]$y
dd</code></pre>
<pre><code>##       i       y t    y.l1
##   1:  1 -0.3884 1      NA
##   2:  1  0.3990 2 -0.3884
##   3:  1  1.0288 3  0.3990
##   4:  1  1.5327 4  1.0288
##   5:  1  1.9358 5  1.5327
##  ---                     
## 184: 20  2.7542 3  1.5453
## 185: 20  3.7214 4  2.7542
## 186: 20  4.4951 5  3.7214
## 187: 20  5.1141 6  4.4951
## 188: 20  5.6093 7  5.1141</code></pre>
<p>The <code>J</code> function creates a data.table with the 2 columsn <code>i,j</code> coming from the wrapping data.table. It creates a running index that will go through the table. Then we can use <code>-1</code> to express that we want to shift this index by one. Any transformation can be performed at this point and one can go 4 periods before or after or anything.</p>
<h3 id="alternative-approach-add-lagged-column-by-reference-with">Alternative approach: add lagged column by reference with <code>:=</code></h3>
<p>There is an alternative approach to the above. It differs mainly in how we add the new column containing the lagged values. When the data.table contains a lot of data, it is preferrable to manipulate it <strong>by reference</strong>, i.e. using the function <code>:=</code>. The following is a slight modification of a related <a href="http://stackoverflow.com/questions/11397771/r-data-table-grouping-for-lagged-regression">stackoverflow.com answer</a>. It relies on the concept of a <em>self-join</em>, i.e. we join the data.table to itself based on the value of a key:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">setcolorder</span>(dd,<span class="kw">c</span>(<span class="st">&quot;i&quot;</span>,<span class="st">&quot;t&quot;</span>,<span class="st">&quot;y&quot;</span>,<span class="st">&quot;y.l1&quot;</span>)) <span class="co"># change column order by reference</span>
dd[<span class="kw">list</span>(i,t<span class="dv">-1</span>)] <span class="co"># evaluate at value of [lagged] key: for each i, the t index is shifted one back</span></code></pre>
<pre><code>##       i t       y    y.l1
##   1:  1 0      NA      NA
##   2:  1 1 -0.3884      NA
##   3:  1 2  0.3990 -0.3884
##   4:  1 3  1.0288  0.3990
##   5:  1 4  1.5327  1.0288
##  ---                     
## 184: 20 2  1.5453  0.0341
## 185: 20 3  2.7542  1.5453
## 186: 20 4  3.7214  2.7542
## 187: 20 5  4.4951  3.7214
## 188: 20 6  5.1141  4.4951</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">dd[,y.l2 :<span class="er">=</span><span class="st"> </span>dd[<span class="kw">list</span>(i,t<span class="dv">-1</span>)][[<span class="st">&quot;y&quot;</span>]]] <span class="co"># just add the &quot;y&quot; column of that to dd by reference</span></code></pre>
<pre><code>##       i t       y    y.l1    y.l2
##   1:  1 1 -0.3884      NA      NA
##   2:  1 2  0.3990 -0.3884 -0.3884
##   3:  1 3  1.0288  0.3990  0.3990
##   4:  1 4  1.5327  1.0288  1.0288
##   5:  1 5  1.9358  1.5327  1.5327
##  ---                             
## 184: 20 3  2.7542  1.5453  1.5453
## 185: 20 4  3.7214  2.7542  2.7542
## 186: 20 5  4.4951  3.7214  3.7214
## 187: 20 6  5.1141  4.4951  4.4951
## 188: 20 7  5.6093  5.1141  5.1141</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">dd[,<span class="kw">all.equal</span>(y.l1,y.l2)]</code></pre>
<pre><code>## [1] TRUE</code></pre>
<p>You can see that this already produces the desired result: the value of <code>y</code></p>

        </div><!--/span-->
      </div><!--/row-->

      <hr>

      <footer>
        <p>Thibaut Lamadon and Florian Oswald</p>
      </footer>

    </div><!--/.fluid-container-->

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="./bootstrap/js/jquery.js"></script>
    <script src="./bootstrap/js/bootstrap-transition.js"></script>
    <script src="./bootstrap/js/bootstrap-alert.js"></script>
    <script src="./bootstrap/js/bootstrap-modal.js"></script>
    <script src="./bootstrap/js/bootstrap-dropdown.js"></script>
    <script src="./bootstrap/js/bootstrap-scrollspy.js"></script>
    <script src="./bootstrap/js/bootstrap-tab.js"></script>
    <script src="./bootstrap/js/bootstrap-tooltip.js"></script>
    <script src="./bootstrap/js/bootstrap-popover.js"></script>
    <script src="./bootstrap/js/bootstrap-button.js"></script>
    <script src="./bootstrap/js/bootstrap-collapse.js"></script>
    <script src="./bootstrap/js/bootstrap-carousel.js"></script>
    <script src="./bootstrap/js/bootstrap-typeahead.js"></script>

  </body>
</html>
